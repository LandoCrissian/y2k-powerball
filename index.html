<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>GL1TCHBALL // Y2K ARCADE</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    :root {
      --bg: #0a0a0f;
      --surface: #16161e;
      --accent: #00ffe1;
      --accent2: #ff00f7;
      --white: #fff;
      --faded: rgba(255,255,255,0.7);
      --error: #ff4444;
      --success: #00ff9d;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      background: var(--bg);
      font-family: 'Orbitron', sans-serif;
      color: var(--white);
      min-height: 100vh;
    }

    .container {
      max-width: 500px;
      margin: auto;
      padding: 20px;
    }

    header {
      text-align: center;
      margin-bottom: 24px;
    }

    .title {
      font-size: 32px;
      font-weight: 900;
      background: linear-gradient(45deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .subtitle {
      font-size: 12px;
      color: var(--faded);
      letter-spacing: 4px;
      margin-top: 6px;
    }

    .connect-btn {
      margin-top: 16px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--white);
      padding: 12px 20px;
      border-radius: 24px;
      font-size: 14px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .connect-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--error);
      transition: background 0.3s ease;
    }

    .connect-btn.connected .connect-dot {
      background: var(--success);
    }

    .status-bar {
      font-size: 12px;
      color: var(--faded);
      margin-top: 10px;
    }

    .profile-card {
      display: none;
      background: var(--surface);
      padding: 16px;
      border-radius: 16px;
      margin-top: 24px;
    }

    .profile-card.active {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .profile-img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 2px solid var(--accent);
      object-fit: cover;
    }

    .profile-info {
      flex: 1;
    }

    .nickname {
      font-size: 16px;
      color: var(--accent);
      font-weight: bold;
    }

    .handle {
      font-size: 12px;
      color: var(--faded);
    }

    .profile-warning {
      font-size: 12px;
      color: var(--accent2);
      margin-top: 4px;
    }

    .cta-link {
      text-decoration: underline;
      cursor: pointer;
      color: var(--accent);
      font-weight: bold;
    }

    .section {
      background: var(--surface);
      border-radius: 14px;
      margin-top: 24px;
      padding: 16px;
    }

    .section-header {
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--accent);
    }

    .section-content {
      margin-top: 12px;
      display: none;
    }

    .section.open .section-content {
      display: block;
    }

    @media screen and (max-width: 480px) {
      .profile-card {
        flex-direction: column;
        text-align: center;
      }
      .profile-img {
        margin-bottom: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">GL1TCHBALL</div>
      <div class="subtitle">VAULT PROTOCOL</div>
      <button id="connectBtn" class="connect-btn">
        <span class="connect-dot"></span>
        <span class="connect-text">CONNECT WALLET</span>
      </button>
      <div id="statusBar" class="status-bar">Waiting for wallet...</div>
    </header>

    <div id="profileCard" class="profile-card">
      <img id="pfpImg" class="profile-img" src="https://api.dicebear.com/6.x/pixel-art/svg?seed=anon" />
      <div class="profile-info">
        <div id="nickname" class="nickname">anon</div>
        <div id="handle" class="handle">@none</div>
        <div id="profileWarning" class="profile-warning" style="display:none;">
          You don’t hold 4M+ Y2K. Customize your badge in the <span class="cta-link" onclick="window.open('https://y2k-the-vault.netlify.app/', '_blank')">Quantum Vault</span>.
        </div>
      </div>
    </div>

    <div id="potsSection" class="section">
      <div class="section-header" onclick="toggleSection(this.parentElement)">
        Token Pots <span>▼</span>
      </div>
      <div class="section-content">
        <p>Y2K: <span id="y2kPot">Loading...</span></p>
        <p>DOJO: <span id="dojoPot">Loading...</span></p>
      </div>
    </div>

    <!-- Placeholder sections (to be populated in Part 2) -->
    <div id="numberPicker"></div>
    <div id="leaderboard"></div>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import {
    getFirestore, doc, getDoc, collection, getDocs, query, orderBy, limit
  } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCJwqDFZtf1PkZwAalOaf2_7eWtej5HIfA",
    authDomain: "y2k-arcade.firebaseapp.com",
    projectId: "y2k-arcade",
    storageBucket: "y2k-arcade.appspot.com",
    messagingSenderId: "1063043176357",
    appId: "1:1063043176357:web:20bc22e9cbf269ff40fa4c"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const connectBtn = document.getElementById("connectBtn");
  const statusBar = document.getElementById("statusBar");
  const profileCard = document.getElementById("profileCard");
  const pfpImg = document.getElementById("pfpImg");
  const nickname = document.getElementById("nickname");
  const handle = document.getElementById("handle");
  const warning = document.getElementById("profileWarning");

  let currentWallet = "";

  connectBtn.addEventListener("click", connectWallet);

  async function connectWallet() {
    if (!window.ethereum) {
      alert("Please install MetaMask.");
      return;
    }

    const provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    const signer = provider.getSigner();
    currentWallet = (await signer.getAddress()).toLowerCase();

    const short = `${currentWallet.slice(0, 6)}...${currentWallet.slice(-4)}`;
    statusBar.textContent = `Connected: ${short}`;
    connectBtn.classList.add("connected");
    connectBtn.querySelector(".connect-text").textContent = "CONNECTED";

    const y2k = await getY2KBalance(currentWallet, provider);

    if (y2k >= 4_000_000) {
      loadVaultProfile(currentWallet);
    } else {
      showGenericProfile(false);
    }

    loadPots();
    initNumberPicker();
    loadLeaderboard();
  }

  async function getY2KBalance(wallet, provider) {
    try {
      const contract = new ethers.Contract(
        "0xB4Df7d2A736Cc391146bB0dF4277E8F68247Ac6d",
        ["function balanceOf(address) view returns (uint256)"],
        provider
      );
      const raw = await contract.balanceOf(wallet);
      return parseFloat(ethers.utils.formatUnits(raw, 18));
    } catch (err) {
      console.error("Y2K Balance Error", err);
      return 0;
    }
  }

  async function loadVaultProfile(wallet) {
    try {
      const snap = await getDoc(doc(db, "users", wallet));
      if (!snap.exists()) {
        showGenericProfile(true);
        return;
      }

      const user = snap.data();
      profileCard.classList.add("active");
      pfpImg.src = user.pfpUrl || "https://api.dicebear.com/6.x/pixel-art/svg?seed=anon";
      nickname.textContent = user.username || "anon";
      handle.textContent = user.xHandle ? `@${user.xHandle}` : "@none";
      warning.style.display = "none";
    } catch (err) {
      console.error("Vault Profile Error", err);
      showGenericProfile(true);
    }
  }

  function showGenericProfile(isEligible) {
    profileCard.classList.add("active");
    pfpImg.src = "https://api.dicebear.com/6.x/pixel-art/svg?seed=anon";
    nickname.textContent = "anon";
    handle.textContent = "@none";

    warning.textContent = isEligible
      ? "Customize your profile in the Quantum Vault."
      : "You don’t hold 4M+ Y2K. Unlock profile customization in the Vault.";
    warning.style.display = "block";
  }

  function toggleSection(section) {
    section.classList.toggle("open");
  }

  window.toggleSection = toggleSection;

  function initNumberPicker() {
    const grid = document.createElement("div");
    grid.className = "section";
    grid.innerHTML = `
      <div class="section-header" onclick="toggleSection(this.parentElement)">Pick 6 Numbers <span>▼</span></div>
      <div class="section-content" id="pickerContent">
        <div style="margin-top:12px; display:grid; grid-template-columns:repeat(6,1fr); gap:8px;" id="pickerGrid"></div>
        <button id="submitDraw" style="margin-top:16px; padding:10px; border:none; background:var(--accent); border-radius:8px; font-weight:bold; cursor:pointer;">ENTER</button>
      </div>
    `;
    document.getElementById("numberPicker").appendChild(grid);

    const pickerGrid = document.getElementById("pickerGrid");
    const selected = new Set();

    for (let i = 1; i <= 24; i++) {
      const btn = document.createElement("div");
      btn.textContent = i;
      btn.style.cssText = "padding:10px;border-radius:50%;background:rgba(255,255,255,0.1);text-align:center;cursor:pointer;";
      btn.onclick = () => {
        if (selected.has(i)) {
          selected.delete(i);
          btn.style.background = "rgba(255,255,255,0.1)";
        } else if (selected.size < 6) {
          selected.add(i);
          btn.style.background = "var(--accent)";
        }
      };
      pickerGrid.appendChild(btn);
    }

    document.getElementById("submitDraw").onclick = () => {
      if (selected.size !== 6) return alert("Pick exactly 6 numbers.");
      alert("Submitted: " + [...selected].sort((a, b) => a - b).join(", "));
    };
  }

  async function loadPots() {
    try {
      const provider = new ethers.providers.JsonRpcProvider("https://evm.cronos.org");
      const potWallet = "0x348c2F06C64b4465f90446Fd806aFf3A01220450";

      const y2k = new ethers.Contract("0xB4Df7d2A736Cc391146bB0dF4277E8F68247Ac6d", ["function balanceOf(address) view returns (uint256)"], provider);
      const dojo = new ethers.Contract("0x6Eb1d264Ceb70Fb38b41893Ac6043087E75c3ae4", ["function balanceOf(address) view returns (uint256)"], provider);

      const [y2kBal, dojoBal] = await Promise.all([
        y2k.balanceOf(potWallet),
        dojo.balanceOf(potWallet)
      ]);

      document.getElementById("y2kPot").textContent = `${parseInt(ethers.utils.formatUnits(y2kBal, 18)).toLocaleString()} Y2K`;
      document.getElementById("dojoPot").textContent = `${parseInt(ethers.utils.formatUnits(dojoBal, 18)).toLocaleString()} DOJO`;
    } catch (err) {
      console.error("Pot Load Error", err);
    }
  }

  async function loadLeaderboard() {
    try {
      const snap = await getDocs(query(collection(db, "users"), orderBy("earnings", "desc"), limit(10)));
      const container = document.createElement("div");
      container.className = "section open";
      container.innerHTML = `
        <div class="section-header" onclick="toggleSection(this.parentElement)">🏆 Top Players <span>▼</span></div>
        <div class="section-content" id="leaderboardList"></div>
      `;
      document.getElementById("leaderboard").appendChild(container);

      const list = document.getElementById("leaderboardList");
      list.innerHTML = "";

      snap.forEach((doc, i) => {
        const user = doc.data();
        const name = user.username || "anon";
        const score = user.earnings || 0;
        list.innerHTML += `<div style="font-size:13px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.1);">#${i + 1} — @${name} | ${score} Y2K</div>`;
      });
    } catch (err) {
      console.error("Leaderboard Error", err);
    }
  }
</script>
</body>
</html>
